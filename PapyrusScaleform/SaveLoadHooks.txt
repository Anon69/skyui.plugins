################################ PapyrusVM.h ################################

class SkyrimVM
{
public:
	SkyrimVM();
	virtual ~SkyrimVM();

	virtual void	Unk_01(void);

//	void	** _vtbl;	// 0000

	UInt32	pad0004[(0x00FC - 0x0004) >> 2];	// 0004

	VMClassRegistry	* m_classRegistry;	// 00FC

	VMClassRegistry	* GetClassRegistry(void)	{ return m_classRegistry; }


	MEMBER_FN_PREFIX(SkyrimVM);
	DEFINE_MEMBER_FN(UnregisterForSleep_Internal, void, 0x008C0240, UInt64 handle);
	DEFINE_MEMBER_FN(SaveRegSleepEventHandles_Internal, bool, 0x008B8EF0, void * saveFileHandle, void * saveStorageWrapper);
	DEFINE_MEMBER_FN(RevertGlobalData_Internal, bool, 0x008C1530);
	DEFINE_MEMBER_FN(LoadRegSleepEventHandles_Internal, bool, 0x008BF3B0, void * saveFileHandle, void * saveStorageWrapper);

	void OnFormDelete_Hook(UInt64 handle);
	bool SaveGlobalData_Hook(void * saveFileHandle, void * saveStorageWrapper);
	void RevertGlobalData_Hook(void);
	bool LoadGlobalData_Hook(void * saveFileHandle, void * saveStorageWrapper);
	
};

################################ PapyrusVM.cpp ################################

void SkyrimVM::OnFormDelete_Hook(UInt64 handle)
{
	CALL_MEMBER_FN(this, UnregisterForSleep_Internal)(handle);

	// TODO

	_MESSAGE("Executed SkyrimVM::OnFormDelete_Hook.");
}

bool SkyrimVM::SaveGlobalData_Hook(void * saveFileHandle, void * saveStorageWrapper)
{
	bool result = CALL_MEMBER_FN(this, SaveRegSleepEventHandles_Internal)(saveFileHandle, saveStorageWrapper);

	// TODO

	_MESSAGE("Executed SkyrimVM::SaveGlobalData_Hook.");

	return result;
}

void SkyrimVM::RevertGlobalData_Hook(void)
{
	CALL_MEMBER_FN(this, RevertGlobalData_Internal)();

	// TODO

	_MESSAGE("Executed SkyrimVM::RevertGlobalData_Hook.");
}

bool SkyrimVM::LoadGlobalData_Hook(void * saveFileHandle, void * saveStorageWrapper)
{
	bool result = CALL_MEMBER_FN(this, LoadRegSleepEventHandles_Internal)(saveFileHandle, saveStorageWrapper);

	// TODO

	_MESSAGE("Executed SkyrimVM::LoadGlobalData_Hook.");

	return result;
}


################################ Hooks_Papyrus.cpp ################################

class SaveLoadManager
{
public:
	MEMBER_FN_PREFIX(SaveLoadManager);
	DEFINE_MEMBER_FN(SaveGame_Internal, void, 0x00672460, const char * fileName);
	DEFINE_MEMBER_FN(LoadGame_Internal, void, 0x006748A0, const char * fileName, bool unk1);

	void SaveGame_Hook(const char * fileName)
	{
		_MESSAGE("Executing SaveLoadManager::SaveGame_Hook. Filename: %s", fileName);

		CALL_MEMBER_FN(this, SaveGame_Internal)(fileName);

		_MESSAGE("Executed SaveLoadManager::SaveGame_Hook. Filename: %s", fileName);
	}

	void LoadGame_Hook(const char * fileName, bool unk1)
	{
		_MESSAGE("Executing SaveLoadManager::LoadGame_Hook. Filename: %s", fileName);

		CALL_MEMBER_FN(this, LoadGame_Internal)(fileName, unk1);

		_MESSAGE("Executed SaveLoadManager::LoadGame_Hook. Filename: %s", fileName);
	}
};

void Hooks_Papyrus_Init(void)
{
	//
}

void Hooks_Papyrus_Commit(void)
{
	WriteRelCall(0x008C3A71, (UInt32)RegisterPapyrusFunctions_Hook);

	// Event registration lifecycle
	WriteRelCall(0x008C1CBA, GetFnAddr(&SkyrimVM::OnFormDelete_Hook));
	WriteRelCall(0x008C20E7, GetFnAddr(&SkyrimVM::RevertGlobalData_Hook));
	WriteRelCall(0x008BEE51, GetFnAddr(&SkyrimVM::SaveGlobalData_Hook));
	WriteRelCall(0x008C22B9, GetFnAddr(&SkyrimVM::LoadGlobalData_Hook));
	
	// Load & save
	WriteRelCall(0x0067A5D2, GetFnAddr(&SaveLoadManager::SaveGame_Hook));
	WriteRelCall(0x0067AF15, GetFnAddr(&SaveLoadManager::LoadGame_Hook));
}